<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App - Личный кабинет</title>
    <script src="https://telegram.org/js/telegram-web-app.js?new"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
        .btn-primary:hover {
            opacity: 0.9;
        }
        body {
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        .input-field {
            background-color: var(--tg-theme-secondary-bg-color, #f3f4f6);
            color: var(--tg-theme-text-color, #000000);
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .forgot-password {
            color: var(--tg-theme-link-color, #2481cc);
            font-size: 0.875rem;
            cursor: pointer;
        }
        .forgot-password:hover {
            text-decoration: underline;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
        <!-- Регистрация -->
        <div id="register-section" class="rounded-lg card p-6 fade-in">
            <h2 class="text-xl font-bold text-center mb-4">Создать аккаунт</h2>
            <form id="register-form" class="space-y-3">
                <div>
                    <label for="fio" class="block text-sm font-medium mb-1">ФИО волонтера</label>
                    <input type="text" id="fio" required
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div>
                    <label for="dob" class="block text-sm font-medium mb-1">Дата рождения</label>
                    <input type="date" id="dob" required
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div>
                    <label for="institute" class="block text-sm font-medium mb-1">Институт</label>
                    <input type="text" id="institute" required
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div>
                    <label for="group" class="block text-sm font-medium mb-1">Группа</label>
                    <input type="text" id="group" required
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium mb-1">Телефон</label>
                    <input type="tel" id="phone" required
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div>
                    <label for="vk" class="block text-sm font-medium mb-1">Ссылка VK</label>
                    <input type="url" id="vk" required
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div>
                    <label for="reg-password" class="block text-sm font-medium mb-1">Пароль</label>
                    <input type="password" id="reg-password" required minlength="6"
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div>
                    <label for="reg-confirm" class="block text-sm font-medium mb-1">Подтвердите пароль</label>
                    <input type="password" id="reg-confirm" required minlength="6"
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div id="register-error" class="text-red-500 text-sm hidden"></div>
                <button type="submit" class="w-full btn-primary py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                    <span id="register-btn-text">Зарегистрироваться</span>
                    <div id="register-loader" class="loader ml-2 hidden"></div>
                </button>
            </form>
            <div class="mt-3 text-center">
                <p class="text-sm">Уже есть аккаунт? <button id="show-login" class="text-blue-500 hover:underline">Войти</button></p>
            </div>
        </div>

        <!-- Вход -->
        <div id="login-section" class="rounded-lg card p-6 fade-in hidden">
            <h2 class="text-xl font-bold text-center mb-4">Вход в аккаунт</h2>
            <form id="login-form" class="space-y-3">
                <div>
                    <label for="login-username" class="block text-sm font-medium mb-1">Имя пользователя</label>
                    <input type="text" id="login-username" required
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium mb-1">Пароль</label>
                    <input type="password" id="login-password" required minlength="6"
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                    <div class="text-right mt-1">
                        <span id="forgot-password" class="forgot-password">Забыли пароль?</span>
                    </div>
                </div>
                <div id="login-error" class="text-red-500 text-sm hidden"></div>
                <button type="submit" class="w-full btn-primary py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                    <span id="login-btn-text">Войти</span>
                    <div id="login-loader" class="loader ml-2 hidden"></div>
                </button>
            </form>
            <div class="mt-3 text-center">
                <p class="text-sm">Нет аккаунта? <button id="show-register" class="text-blue-500 hover:underline">Зарегистрироваться</button></p>
            </div>
        </div>

        <!-- Восстановление пароля -->
        <div id="recovery-section" class="rounded-lg card p-6 fade-in hidden">
            <h2 class="text-xl font-bold text-center mb-4">Восстановление пароля</h2>
            <form id="recovery-form" class="space-y-3">
                <div>
                    <label for="recovery-username" class="block text-sm font-medium mb-1">Имя пользователя</label>
                    <input type="text" id="recovery-username" required
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div>
                    <label for="recovery-phone" class="block text-sm font-medium mb-1">Телефон</label>
                    <input type="tel" id="recovery-phone" required
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div id="recovery-error" class="text-red-500 text-sm hidden"></div>
                <div id="recovery-success" class="text-green-500 text-sm hidden"></div>
                <button type="submit" class="w-full btn-primary py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                    <span id="recovery-btn-text">Восстановить пароль</span>
                    <div id="recovery-loader" class="loader ml-2 hidden"></div>
                </button>
            </form>
            <div class="mt-3 text-center">
                <p class="text-sm">Вспомнили пароль? <button id="show-login-from-recovery" class="text-blue-500 hover:underline">Войти</button></p>
            </div>
        </div>

        <!-- Личный кабинет -->
        <div id="dashboard-section" class="rounded-lg card p-6 fade-in hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Личный кабинет</h2>
                <button id="logout-btn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
            <div class="space-y-3">
                <div class="flex items-center">
                    <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                        <i class="fas fa-user text-blue-500 text-xl"></i>
                    </div>
                    <div>
                        <h3 id="user-fio" class="font-semibold"></h3>
                        <p id="user-username" class="text-sm opacity-80"></p>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <h3 class="font-medium mb-2">Информация о профиле</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <p class="text-xs opacity-70">Дата рождения</p>
                            <p id="user-dob" class="font-medium text-sm"></p>
                        </div>
                        <div>
                            <p class="text-xs opacity-70">Институт</p>
                            <p id="user-institute" class="font-medium text-sm"></p>
                        </div>
                        <div>
                            <p class="text-xs opacity-70">Группа</p>
                            <p id="user-group" class="font-medium text-sm"></p>
                        </div>
                        <div>
                            <p class="text-xs opacity-70">Телефон</p>
                            <p id="user-phone" class="font-medium text-sm"></p>
                        </div>
                        <div>
                            <p class="text-xs opacity-70">Ссылка VK</p>
                            <p id="user-vk" class="font-medium text-sm"></p>
                        </div>
                        <div>
                            <p class="text-xs opacity-70">Дата регистрации</p>
                            <p id="reg-date" class="font-medium text-sm"></p>
                        </div>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <button id="change-password-btn" class="w-full py-2 px-4 rounded-lg border border-gray-300 hover:bg-gray-50 transition duration-200">
                        Изменить пароль
                    </button>
                </div>
            </div>
        </div>

        <!-- Изменение пароля -->
        <div id="change-password-section" class="rounded-lg card p-6 fade-in hidden">
            <h2 class="text-xl font-bold text-center mb-4">Изменение пароля</h2>
            <form id="change-password-form" class="space-y-3">
                <div>
                    <label for="current-password" class="block text-sm font-medium mb-1">Текущий пароль</label>
                    <input type="password" id="current-password" required minlength="6"
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div>
                    <label for="new-password" class="block text-sm font-medium mb-1">Новый пароль</label>
                    <input type="password" id="new-password" required minlength="6"
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div>
                    <label for="confirm-new-password" class="block text-sm font-medium mb-1">Подтвердите новый пароль</label>
                    <input type="password" id="confirm-new-password" required minlength="6"
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div id="change-password-error" class="text-red-500 text-sm hidden"></div>
                <div id="change-password-success" class="text-green-500 text-sm hidden"></div>
                <div class="flex space-x-3">
                    <button type="button" id="cancel-change-password" class="w-1/2 py-2 px-4 rounded-lg border border-gray-300 hover:bg-gray-50 transition duration-200">
                        Отмена
                    </button>
                    <button type="submit" class="w-1/2 btn-primary py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center">
                        <span id="change-password-btn-text">Изменить</span>
                        <div id="change-password-loader" class="loader ml-2 hidden"></div>
                    </button>
                </div>
            </form>
        </div>

        <!-- Кнопка для тестирования вне Telegram -->
        <div id="telegram-btn" class="mt-4 text-center hidden">
            <a href="https://t.me/your_bot_username?start=webapp"
               class="inline-flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg">
                <i class="fab fa-telegram mr-2"></i> Открыть в Telegram
            </a>
        </div>
    </div>

    <script>
        // Проверяем, запущено ли приложение в Telegram WebApp
        const isTelegram = window.Telegram && window.Telegram.WebApp;
        
        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            // Показываем кнопку "Открыть в Telegram", если не в Telegram
            if (!isTelegram) {
                document.getElementById('telegram-btn').classList.remove('hidden');
            } else {
                // Инициализируем Telegram WebApp
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                
                // Можно использовать данные пользователя Telegram
                const tgUser = Telegram.WebApp.initDataUnsafe.user;
                if (tgUser) {
                    document.getElementById('login-username').value = tgUser.username || '';
                }
                
                // Проверяем, авторизован ли пользователь
                checkAuthStatus();
            }
            
            // Обработчики событий
            document.getElementById('show-login').addEventListener('click', showLogin);
            document.getElementById('show-register').addEventListener('click', showRegister);
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('forgot-password').addEventListener('click', showRecovery);
            document.getElementById('show-login-from-recovery').addEventListener('click', showLogin);
            document.getElementById('change-password-btn').addEventListener('click', showChangePassword);
            document.getElementById('cancel-change-password').addEventListener('click', cancelChangePassword);
            
            // Обработчики форм
            document.getElementById('register-form').addEventListener('submit', registerUser);
            document.getElementById('login-form').addEventListener('submit', loginUser);
            document.getElementById('recovery-form').addEventListener('submit', recoverPassword);
            document.getElementById('change-password-form').addEventListener('submit', changePassword);
        });

        // Проверить статус авторизации
        function checkAuthStatus() {
            if (!isTelegram) return;
            
            showLoader('login');
            
            // Отправляем запрос на проверку авторизации
            Telegram.WebApp.answerWebAppQuery(JSON.stringify({
                action: 'check_auth',
                user: {
                    username: document.getElementById('login-username').value
                }
            }));
        }

        // Показать форму входа
        function showLogin() {
            document.getElementById('register-section').classList.add('hidden');
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('recovery-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('change-password-section').classList.add('hidden');
            
            // Очищаем сообщения об ошибках
            document.getElementById('login-error').classList.add('hidden');
        }

        // Показать форму регистрации
        function showRegister() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('register-section').classList.remove('hidden');
            document.getElementById('recovery-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.add
                        document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('change-password-section').classList.add('hidden');
            
            // Очищаем сообщения об ошибках
            document.getElementById('register-error').classList.add('hidden');
        }

        // Показать форму восстановления пароля
        function showRecovery() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('register-section').classList.add('hidden');
            document.getElementById('recovery-section').classList.remove('hidden');
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('change-password-section').classList.add('hidden');
            
            // Очищаем сообщения
            document.getElementById('recovery-error').classList.add('hidden');
            document.getElementById('recovery-success').classList.add('hidden');
        }

        // Показать личный кабинет с данными пользователя
        function showDashboard(user) {
            document.getElementById('register-section').classList.add('hidden');
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('recovery-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            document.getElementById('change-password-section').classList.add('hidden');
            
            // Заполняем данные пользователя
            document.getElementById('user-fio').textContent = user.ФИО_волонтера;
            document.getElementById('user-username').textContent = user.Имя_пользователя;
            document.getElementById('user-dob').textContent = user.Дата_рождения;
            document.getElementById('user-institute').textContent = user.Институт;
            document.getElementById('user-group').textContent = user.Группа;
            document.getElementById('user-phone').textContent = user.Телефон;
            document.getElementById('user-vk').textContent = user.Ссылка_VK;
            
            // Форматируем дату регистрации
            const regDate = new Date(user.Дата_Регистрации);
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('reg-date').textContent = regDate.toLocaleDateString('ru-RU', options);
        }

        // Показать форму изменения пароля
        function showChangePassword() {
            document.getElementById('change-password-section').classList.remove('hidden');
            document.getElementById('dashboard-section').classList.add('hidden');
            
            // Очищаем сообщения
            document.getElementById('change-password-error').classList.add('hidden');
            document.getElementById('change-password-success').classList.add('hidden');
        }

        // Отмена изменения пароля
        function cancelChangePassword() {
            document.getElementById('change-password-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            
            // Очищаем поля формы
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-new-password').value = '';
        }

        // Регистрация нового пользователя
        function registerUser(e) {
            e.preventDefault();
            
            const fio = document.getElementById('fio').value.trim();
            const dob = document.getElementById('dob').value.trim();
            const institute = document.getElementById('institute').value.trim();
            const group = document.getElementById('group').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const vk = document.getElementById('vk').value.trim();
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-confirm').value;
            
            // Валидация
            const errorElement = document.getElementById('register-error');
            if (password !== confirmPassword) {
                errorElement.textContent = 'Пароли не совпадают';
                errorElement.classList.remove('hidden');
                return;
            }
            if (password.length < 6) {
                errorElement.textContent = 'Пароль должен содержать минимум 6 символов';
                errorElement.classList.remove('hidden');
                return;
            }
            
            showLoader('register');
            
            // Создаем объект с данными пользователя
            const userData = {
                action: 'register',
                user: {
                    ФИО_волонтера: fio,
                    Дата_рождения: dob,
                    Институт: institute,
                    Группа: group,
                    Телефон: phone,
                    Ссылка_VK: vk,
                    Пароль: password
                }
            };
            
            // Отправляем данные в бота через Telegram WebApp
            Telegram.WebApp.answerWebAppQuery(JSON.stringify(userData));
        }

        // Вход пользователя
        function loginUser(e) {
            e.preventDefault();
            
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            
            showLoader('login');
            
            // Создаем объект с данными для входа
            const loginData = {
                action: 'login',
                user: {
                    Имя_пользователя: username,
                    Пароль: password
                }
            };
            
            // Отправляем данные в бота через Telegram WebApp
            Telegram.WebApp.answerWebAppQuery(JSON.stringify(loginData));
        }

        // Восстановление пароля
        function recoverPassword(e) {
            e.preventDefault();
            
            const username = document.getElementById('recovery-username').value.trim();
            const phone = document.getElementById('recovery-phone').value.trim();
            
            showLoader('recovery');
            
            // Создаем объект с данными для восстановления
            const recoveryData = {
                action: 'recover_password',
                user: {
                    Имя_пользователя: username,
                    Телефон: phone
                }
            };
            
            // Отправляем данные в бота через Telegram WebApp
            Telegram.WebApp.answerWebAppQuery(JSON.stringify(recoveryData));
        }

        // Изменение пароля
        function changePassword(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmNewPassword = document.getElementById('confirm-new-password').value;
            
            // Валидация
            const errorElement = document.getElementById('change-password-error');
            if (newPassword !== confirmNewPassword) {
                errorElement.textContent = 'Новые пароли не совпадают';
                errorElement.classList.remove('hidden');
                return;
            }
            if (newPassword.length < 6) {
                errorElement.textContent = 'Пароль должен содержать минимум 6 символов';
                errorElement.classList.remove('hidden');
                return;
            }
            
            showLoader('change-password');
            
            // Создаем объект с данными для изменения пароля
            const changePasswordData = {
                action: 'change_password',
                user: {
                    current_password: currentPassword,
                    new_password: newPassword
                }
            };
            
            // Отправляем данные в бота через Telegram WebApp
            Telegram.WebApp.answerWebAppQuery(JSON.stringify(changePasswordData));
        }

        // Выход из системы
        function logout() {
            if (isTelegram) {
                Telegram.WebApp.close();
            } else {
                showLogin();
            }
        }

        // Показать индикатор загрузки
        function showLoader(type) {
            const types = {
                'register': ['register-btn-text', 'register-loader'],
                'login': ['login-btn-text', 'login-loader'],
                'recovery': ['recovery-btn-text', 'recovery-loader'],
                'change-password': ['change-password-btn-text', 'change-password-loader']
            };
            
            if (types[type]) {
                document.getElementById(types[type][0]).classList.add('hidden');
                document.getElementById(types[type][1]).classList.remove('hidden');
            }
        }

        // Скрыть индикатор загрузки
        function hideLoader(type) {
            const types = {
                'register': ['register-btn-text', 'register-loader'],
                'login': ['login-btn-text', 'login-loader'],
                'recovery': ['recovery-btn-text', 'recovery-loader'],
                'change-password': ['change-password-btn-text', 'change-password-loader']
            };
            
            if (types[type]) {
                document.getElementById(types[type][0]).classList.remove('hidden');
                document.getElementById(types[type][1]).classList.add('hidden');
            }
        }

        // Обработчик событий от Telegram WebApp
        Telegram.WebApp.onEvent('webAppDataReceived', function(event) {
            try {
                const data = JSON.parse(event);
                
                if (data.success) {
                    if (data.action === 'register' || data.action === 'login') {
                        showDashboard(data.user);
                    } else if (data.action === 'recover_password') {
                        // Показываем сообщение об успешном восстановлении
                        document.getElementById('recovery-error').classList.add('hidden');
                        const successElement = document.getElementById('recovery-success');
                        successElement.textContent = 'Новый пароль был отправлен на ваш телефон';
                        successElement.classList.remove('hidden');
                        hideLoader('recovery');
                        
                        // Очищаем поля формы
                        document.getElementById('recovery-username').value = '';
                        document.getElementById('recovery-phone').value = '';
                    } else if (data.action === 'change_password') {
                        // Показываем сообщение об успешном изменении пароля
                        document.getElementById('change-password-error').classList.add('hidden');
                        const successElement = document.getElementById('change-password-success');
                        successElement.textContent = 'Пароль успешно изменен';
                        successElement.classList.remove('hidden');
                        hideLoader('change-password');
                        
                        // Очищаем поля формы
                        document.getElementById('current-password').value = '';
                        document.getElementById('new-password').value = '';
                        document.getElementById('confirm-new-password').value = '';
                        
                        // Возвращаемся в личный кабинет через 2 секунды
                        setTimeout(() => {
                            document.getElementById('change-password-section').classList.add('hidden');
                            document.getElementById('dashboard-section').classList.remove('hidden');
                            document.getElementById('change-password-success').classList.add('hidden');
                        }, 2000);
                    }
                } else {
                    const errorElement = 
                        data.action === 'register' ? document.getElementById('register-error') :
                        data.action === 'login' ? document.getElementById('login-error') :
                        data.action === 'recover_password' ? document.getElementById('recovery-error') :
                        document.getElementById('change-password-error');
                    
                    errorElement.textContent = data.message;
                    errorElement.classList.remove('hidden');
                    
                    hideLoader(data.action);
                }
            } catch (e) {
                console.error('Error parsing response:', e);
                hideLoader('register');
                hideLoader('login');
                hideLoader('recovery');
                hideLoader('change-password');
            }
        });
    </script>
</body>
</html>
