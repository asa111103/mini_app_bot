<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App - Личный кабинет волонтера</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
        .btn-primary:hover {
            opacity: 0.9;
        }
        body {
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        .input-field {
            background-color: var(--tg-theme-secondary-bg-color, #f3f4f6);
            color: var(--tg-theme-text-color, #000000);
        }
        .info-card {
            background-color: var(--tg-theme-secondary-bg-color, #f3f4f6);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .dobro-badge {
            background-color: #f59e0b;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md">
        <!-- Регистрация -->
        <div id="register-section" class="rounded-lg card p-6 fade-in">
            <h2 class="text-xl font-bold text-center mb-4">Регистрация волонтера</h2>
            <form id="register-form" class="space-y-3">
                <div>
                    <label for="fio" class="block text-sm font-medium mb-1">ФИО волонтера *</label>
                    <input type="text" id="fio" required
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div>
                    <label for="dob" class="block text-sm font-medium mb-1">Дата рождения *</label>
                    <input type="date" id="dob" required max=""
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div>
                    <label for="institute" class="block text-sm font-medium mb-1">Институт *</label>
                    <input type="text" id="institute" required
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div>
                    <label for="group" class="block text-sm font-medium mb-1">Группа *</label>
                    <input type="text" id="group" required
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div>
                    <label for="phone" class="block text-sm font-medium mb-1">Телефон *</label>
                    <input type="tel" id="phone" required
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none"
                        placeholder="+7 (XXX) XXX-XX-XX">
                </div>
                <div>
                    <label for="vk" class="block text-sm font-medium mb-1">Ссылка VK *</label>
                    <input type="url" id="vk" required
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none"
                        placeholder="https://vk.com/username">
                </div>
                <div>
                    <label for="dobro" class="block text-sm font-medium mb-1">Баллы Добро *</label>
                    <input type="number" id="dobro" required min="0" value="0"
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div>
                    <label for="reg-password" class="block text-sm font-medium mb-1">Пароль *</label>
                    <input type="password" id="reg-password" required minlength="6"
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div>
                    <label for="reg-confirm" class="block text-sm font-medium mb-1">Подтвердите пароль *</label>
                    <input type="password" id="reg-confirm" required minlength="6"
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div id="register-error" class="text-red-500 text-sm hidden"></div>
                <button type="submit" class="w-full btn-primary py-2 px-4 rounded-lg transition duration-200">
                    Зарегистрироваться
                </button>
            </form>
            <div class="mt-3 text-center">
                <p class="text-sm">Уже есть аккаунт? <button id="show-login" class="text-blue-500 hover:underline">Войти</button></p>
            </div>
        </div>

        <!-- Вход -->
        <div id="login-section" class="rounded-lg card p-6 fade-in hidden">
            <h2 class="text-xl font-bold text-center mb-4">Вход в аккаунт</h2>
            <form id="login-form" class="space-y-3">
                <div>
                    <label for="login-username" class="block text-sm font-medium mb-1">Имя пользователя *</label>
                    <input type="text" id="login-username" required
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium mb-1">Пароль *</label>
                    <input type="password" id="login-password" required minlength="6"
                        class="w-full px-3 py-2 rounded-lg border input-field focus:outline-none">
                </div>
                <div id="login-error" class="text-red-500 text-sm hidden"></div>
                <button type="submit" class="w-full btn-primary py-2 px-4 rounded-lg transition duration-200">
                    Войти
                </button>
            </form>
            <div class="mt-3 text-center">
                <p class="text-sm">Нет аккаунта? <button id="show-register" class="text-blue-500 hover:underline">Зарегистрироваться</button></p>
            </div>
        </div>

        <!-- Личный кабинет -->
        <div id="dashboard-section" class="rounded-lg card p-6 fade-in hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Личный кабинет</h2>
                <button id="logout-btn" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>

            <div class="space-y-3">
                <div class="flex items-center">
                    <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                        <i class="fas fa-user text-blue-500 text-xl"></i>
                    </div>
                    <div>
                        <h3 id="user-fio" class="font-semibold"></h3>
                        <p id="user-username" class="text-sm opacity-80"></p>
                    </div>
                </div>

                <div class="mt-4 space-y-2">
                    <div class="info-card flex justify-between items-center">
                        <div>
                            <p class="text-xs opacity-70">ID Добро</p>
                            <p id="user-id-dobro" class="font-medium text-sm"></p>
                        </div>
                        <div>
                            <p class="text-xs opacity-70">Баллы</p>
                            <div id="user-dobro" class="dobro-badge text-sm">
                                <i class="fas fa-star mr-1"></i>
                                <span>0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <p class="text-xs opacity-70">Дата рождения</p>
                        <p id="user-dob" class="font-medium text-sm"></p>
                    </div>
                    <div class="info-card">
                        <p class="text-xs opacity-70">Институт</p>
                        <p id="user-institute" class="font-medium text-sm"></p>
                    </div>
                    <div class="info-card">
                        <p class="text-xs opacity-70">Группа</p>
                        <p id="user-group" class="font-medium text-sm"></p>
                    </div>
                    <div class="info-card">
                        <p class="text-xs opacity-70">Телефон</p>
                        <p id="user-phone" class="font-medium text-sm"></p>
                    </div>
                    <div class="info-card">
                        <p class="text-xs opacity-70">Ссылка VK</p>
                        <p id="user-vk" class="font-medium text-sm"></p>
                    </div>
                    <div class="info-card">
                        <p class="text-xs opacity-70">Дата регистрации</p>
                        <p id="reg-date" class="font-medium text-sm"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Кнопка для тестирования вне Telegram -->
        <div id="telegram-btn" class="mt-4 text-center hidden">
            <a href="https://t.me/your_bot_username?start=webapp"
               class="inline-flex items-center px-4 py-2 bg-blue-500 text-white rounded-lg">
                <i class="fab fa-telegram mr-2"></i> Открыть в Telegram
            </a>
        </div>
    </div>
    <script>
        // Проверяем, запущено ли приложение в Telegram WebApp
        const isTelegram = window.Telegram && window.Telegram.WebApp;

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', function() {
            // Установка максимальной даты рождения (сегодня)
            document.getElementById('dob').max = new Date().toISOString().split('T')[0];
            
            // Показываем кнопку "Открыть в Telegram", если не в Telegram
            if (!isTelegram) {
                document.getElementById('telegram-btn').classList.remove('hidden');
            } else {
                // Инициализируем Telegram WebApp
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();

                // Используем данные пользователя Telegram
                const tgUser = Telegram.WebApp.initDataUnsafe.user;
                if (tgUser) {
                    document.getElementById('login-username').value = tgUser.username || '';
                    
                    // Автозаполнение имени из Telegram
                    const nameInput = document.getElementById('fio');
                    if (tgUser.first_name) {
                        nameInput.value = tgUser.first_name;
                        if (tgUser.last_name) {
                            nameInput.value += ' ' + tgUser.last_name;
                        }
                    }
                }
            }

            // Проверяем, авторизован ли пользователь
            const currentUser = localStorage.getItem('currentUser');
            if (currentUser) {
                showDashboard(JSON.parse(currentUser));
            } else {
                document.getElementById('register-section').classList.remove('hidden');
            }

            // Обработчики событий
            document.getElementById('show-login').addEventListener('click', showLogin);
            document.getElementById('show-register').addEventListener('click', showRegister);
            document.getElementById('logout-btn').addEventListener('click', logout);

            // Обработчики форм
            document.getElementById('register-form').addEventListener('submit', registerUser);
            document.getElementById('login-form').addEventListener('submit', loginUser);
            
            // Маска для телефона
            const phoneInput = document.getElementById('phone');
            phoneInput.addEventListener('input', function(e) {
                const x = e.target.value.replace(/\D/g, '').match(/(\d{0,1})(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
                e.target.value = !x[2] ? x[1] : '+7 (' + x[2] + (x[3] ? ') ' + x[3] : '') + (x[4] ? '-' + x[4] : '') + (x[5] ? '-' + x[5] : '');
            });
        });

        // Показать форму входа
        function showLogin() {
            document.getElementById('register-section').classList.add('hidden');
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('dashboard-section').classList.add('hidden');
        }

        // Показать форму регистрации
        function showRegister() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('register-section').classList.remove('hidden');
            document.getElementById('dashboard-section').classList.add('hidden');
        }

        // Показать личный кабинет
        function showDashboard(user) {
            document.getElementById('register-section').classList.add('hidden');
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');

            // Заполняем данные пользователя
            document.getElementById('user-fio').textContent = user.ФИО_волонтера;
            document.getElementById('user-username').textContent = user.Имя_пользователя;
            document.getElementById('user-id-dobro').textContent = user.ID_Добро || '—';
            document.getElementById('user-dob').textContent = formatDate(user.Дата_рождения);
            document.getElementById('user-institute').textContent = user.Институт;
            document.getElementById('user-group').textContent = user.Группа;
            document.getElementById('user-phone').textContent = user.Телефон;
            document.getElementById('user-vk').textContent = user.Ссылка_VK;
            document.getElementById('user-dobro').querySelector('span').textContent = user.Добро || '0';
            document.getElementById('reg-date').textContent = formatDate(user.Дата_Регистрации?.split(' ')[0] || new Date().toISOString());

            // Сохраняем обновленные данные
            localStorage.setItem('currentUser', JSON.stringify(user));
        }

        // Форматирование даты в DD.MM.YYYY
        function formatDate(dateStr) {
            if (!dateStr) return '—';
            
            try {
                // Пытаемся разобрать дату в формате YYYY-MM-DD
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    return `${parts[2]}.${parts[1]}.${parts[0]}`;
                }
                
                // Пытаемся разобрать дату в формате YYYY-MM-DD HH:MM:SS
                const datePart = dateStr.split(' ')[0];
                const dateParts = datePart.split('-');
                if (dateParts.length === 3) {
                    return `${dateParts[2]}.${dateParts[1]}.${dateParts[0]}`;
                }
                
                return dateStr;
            } catch (e) {
                return dateStr;
            }
        }

        // Регистрация нового пользователя
        function registerUser(e) {
            e.preventDefault();

            const fio = document.getElementById('fio').value.trim();
            const dob = document.getElementById('dob').value;
            const institute = document.getElementById('institute').value.trim();
            const group = document.getElementById('group').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const vk = document.getElementById('vk').value.trim();
            const dobro = document.getElementById('dobro').value;
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-confirm').value;
            const username = isTelegram ? Telegram.WebApp.initDataUnsafe.user.username : 'user_' + Math.random().toString(36).substr(2, 5);

            // Валидация
            const errorElement = document.getElementById('register-error');
            errorElement.classList.add('hidden');

            if (!fio) {
                errorElement.textContent = 'Укажите ФИО волонтера';
                errorElement.classList.remove('hidden');
                return;
            }

            if (!dob) {
                errorElement.textContent = 'Укажите дату рождения';
                errorElement.classList.remove('hidden');
                return;
            }

            if (!institute) {
                errorElement.textContent = 'Укажите институт';
                errorElement.classList.remove('hidden');
                return;
            }

            if (!group) {
                errorElement.textContent = 'Укажите группу';
                errorElement.classList.remove('hidden');
                return;
            }

                        if (!phone || phone.length < 5) {
                errorElement.textContent = 'Укажите корректный номер телефона';
                errorElement.classList.remove('hidden');
                return;
            }

            if (!vk || !vk.startsWith('https://vk.com/')) {
                errorElement.textContent = 'Укажите корректную ссылку VK (начинается с https://vk.com/)';
                errorElement.classList.remove('hidden');
                return;
            }

            if (password !== confirmPassword) {
                errorElement.textContent = 'Пароли не совпадают';
                errorElement.classList.remove('hidden');
                return;
            }

            if (password.length < 6) {
                errorElement.textContent = 'Пароль должен содержать минимум 6 символов';
                errorElement.classList.remove('hidden');
                return;
            }

            // Создаем нового пользователя
            const newUser = {
                user_id: isTelegram ? Telegram.WebApp.initDataUnsafe.user.id : Date.now(),
                ID_Добро: 0, // Будет установлено сервером
                Имя_пользователя: username,
                ФИО_волонтера: fio,
                Дата_рождения: dob,
                Институт: institute,
                Группа: group,
                Телефон: phone,
                Ссылка_VK: vk,
                Добро: parseInt(dobro) || 0,
                Пароль: btoa(password),
                Дата_Регистрации: new Date().toISOString()
            };

            // Отправляем данные в бота
            if (isTelegram) {
                Telegram.WebApp.sendData(JSON.stringify({
                    action: 'register',
                    user: newUser
                }));
            } else {
                // Для тестирования вне Telegram
                // Генерируем случайный ID Добро
                newUser.ID_Добро = Math.floor(1000 + Math.random() * 9000);
                
                // Сохраняем пользователя в localStorage
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                users[username] = newUser;
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(newUser));
                
                showDashboard(newUser);
            }
        }

        // Вход пользователя
        function loginUser(e) {
            e.preventDefault();

            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;

            // Валидация
            const errorElement = document.getElementById('login-error');
            errorElement.classList.add('hidden');

            if (!username) {
                errorElement.textContent = 'Введите имя пользователя';
                errorElement.classList.remove('hidden');
                return;
            }

            if (password.length < 6) {
                errorElement.textContent = 'Пароль должен содержать минимум 6 символов';
                errorElement.classList.remove('hidden');
                return;
            }

            // Отправляем данные в бота
            if (isTelegram) {
                Telegram.WebApp.sendData(JSON.stringify({
                    action: 'login',
                    user: {
                        Имя_пользователя: username,
                        Пароль: btoa(password)
                    }
                }));
            } else {
                // Для тестирования вне Telegram
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                const user = users[username];
                
                if (user && btoa(password) === user.Пароль) {
                    showDashboard(user);
                } else {
                    errorElement.textContent = 'Неверное имя пользователя или пароль';
                    errorElement.classList.remove('hidden');
                }
            }
        }

        // Выход из системы
        function logout() {
            localStorage.removeItem('currentUser');
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('login-error').classList.add('hidden');

            if (isTelegram) {
                Telegram.WebApp.close();
            } else {
                showLogin();
            }
        }

        // Обработка ответа от бота
        if (isTelegram) {
            Telegram.WebApp.onEvent('mainButtonClicked', function() {
                Telegram.WebApp.sendData(JSON.stringify({
                    action: 'get_user_data'
                }));
            });
        }
    </script>
</body>
</html>

                
